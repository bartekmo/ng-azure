{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "0.0.1",
  "parameters": {
    "fwVmName": {
      "type": "string",
      "metadata": {
        "description": "Firewall Name"
      }
    },
    "fwVmVersion": {
      "type": "string",
      "metadata": {
        "description": "Firmware version"
      },
      "defaultValue": "latest"
    },
    "fwVmSku": {
      "type": "string",
      "metadata": {
        "description": "License scheme"
      },
      "defaultValue": "hourly"
    },
    "fwVmSize": {
      "type": "string",
      "metadata": {
        "description": "firewall VM size"
      }
    },
    "fwVmAddress": {
      "type": "string",
      "metadata": {
        "description": "Barracuda CloudGen Firewall private IP address"
      }
    },
    "publicIp": {
      "type": "object",
      "metadata": {
        "description": "Public IP object"
      }
    },
    "newStorageAccount": {
      "type": "object",
      "metadata": {
        "description": "New storage account object"
      },
      "defaultValue": {}
    },
    "vnet": {
      "type": "object",
      "metadata": {
        "description": "VNet and subnet object"
      }
    },
    "fwMgmtType": {
      "type": "string",
      "metadata": {
        "description": "how do you manage your firewall?"
      },
      "allowedValues": [
        "ngadmin",
        "webui",
        "ngcc"
      ],
      "defaultValue": "ngadmin"
    },
    "fwCcData": {
      "type": "object",
      "metadata": {
        "description": "Collection of Control Center data"
      },
      "defaultValue": {}
    },
    "fwParFileUrl": {
      "type": "string",
      "metadata": {
        "description": "Configuration backup PAR file"
      },
      "defaultValue": ""
    },
    "fwSshEnable": {
      "type": "string",
      "metadata": {
        "description": "SSH management access enabled"
      },
      "defaultValue": "0"
    },
    "fwSshKey": {
      "type": "secureObject",
      "metadata": {
        "description": "SSH public key"
      },
      "defaultValue": {
        "password": null,
        "sshPublicKey": "",
        "authenticationType": "sshPublicKey"
      }
    },
    "fwPassword": {
      "type": "secureString",
      "metadata": {
        "description": "Root password"
      },
      "defaultValue": ""
    },
    "location": {
      "type": "string",
      "metadata": {
        "description": "Azure region to deploy"
      },
      "defaultValue": "[resourceGroup().location]"
    },
    "baseUrl": {
      "type": "string",
      "metadata": {
        "description": "The base URL for dependent assets",
        "artifactsBaseUrl": ""
      },
      "defaultValue": "https://raw.githubusercontent.com/bartekmo/ng-azure/ngf2/marketplace-barracuda-ngf"
    }
  },
  "variables": {
    "apiVersion": {
      "Compute": "2017-12-01",
      "Network": "2017-10-01",
      "Resources": "2017-05-10"
    },
    "publicIpHolder0": "[if( equals(parameters( 'publicIp' ).newOrExistingOrNone, 'existing' ), parameters( 'publicIp').domainNameLabel, '' )]",
    "publicIpRef": "[if( equals( parameters( 'publicIp' ).newOrExistingOrNone, 'new' ), parameters( 'publicIp').domainNameLabel, '' )]",
    "fwSubnetRefFromParam": "[concat( resourceId( parameters( 'vnet' ).resourceGroup, 'Microsoft.Network/virtualNetworks', parameters( 'vnet' ).name ), '/subnets/', parameters( 'vnet' ).subnets.fwSubnet.name )]"
  },
  "resources": [
    {
      "name": "vNet",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "[variables( 'apiVersion' ).Resources ]",
      "properties": {
        "templateLink": {
          "uri": "[concat( parameters( 'baseUrl'), '/vnet.json' )]"
        },
        "mode": "[deployment().properties.mode]",
        "parameters": {
            "apiVersion": {
              "value": "[variables( 'apiVersion' )]"
            },
            "location": {
              "value": "[parameters( 'location' )]"
            },
            "vnet": {
              "value": "[parameters( 'vnet' )]"
            },
            "fwVmAddress": {
              "value": "[parameters( 'fwVmAddress' )]"
            }
        }
      }
    },
    {
      "name": "publicIp",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "[variables( 'apiVersion' ).Resources ]",
      "condition": "[not( equals( parameters( 'publicIp' ).newOrExistingOrNone, 'none' ))]",
      "properties": {
        "templateLink": {
          "uri": "[concat( parameters( 'baseUrl'), '/pip.json' )]"
        },
        "mode": "[deployment().properties.mode]",
        "parameters": {
            "apiVersion": {
              "value": "[variables( 'apiVersion' )]"
            },
            "location": {
              "value": "[parameters( 'location' )]"
            },
            "pip": {
              "value": "[parameters( 'publicIp' )]"
            }
        }
      }
    },
    {
      "name": "firewallNic",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "[variables( 'apiVersion' ).Resources ]",
      "dependsOn": [
        "[resourceId( 'Microsoft.Resources/deployments', 'vNet' )]",
        "[resourceId( 'Microsoft.Resources/deployments', 'publicIp' )]"
      ],
      "properties": {
        "templateLink": {
          "uri": "[concat( parameters( 'baseUrl'), '/nic.json' )]"
        },
        "mode": "Incremental",
        "parameters": {
          "apiVersion": {
            "value": "[variables( 'apiVersion' )]"
          },
          "location": {
            "value": "[parameters( 'location' )]"
          },
          "nicName": {
            "value": "[concat( parameters( 'fwVmName' ), '-nic0' )]"
          },
          "publicIpRef": {
            "value": "[if( not( equals( parameters( 'publicIp').newOrExistingOrNone, 'none' )), reference( 'publicIp', variables( 'apiVersion' ).Resources ).outputs.selfLink.value, '' )]"
          },
          "fwVmAddress": {
            "value": "[parameters( 'fwVmAddress' )]"
          },
          "fwSubnetRef": {
            "value": "[if( equals( parameters( 'vnet' ).newOrExisting, 'existing' ), variables( 'fwSubnetRefFromParam' ), reference( 'vnet' , variables( 'apiVersion' ).Resources ).outputs.fwSubnetRef.value )]"
          }
        }
      }
    },

    {
      "name": "attachRouting",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "[variables( 'apiVersion' ).Resources ]",
      "resourceGroup": "[parameters( 'vnet' ).resourceGroup]",
      "dependsOn": [
        "vnet"
      ],
      "condition": "[equals( parameters( 'vnet' ).newOrExisting, 'existing' )]",
      "properties": {
        "mode": "Incremental",
        "parameters": {},
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
          "contentVersion": "0.1",
          "parameters": {},
          "variables": {},
          "resources": [
            {
              "type": "Microsoft.Network/virtualNetworks/subnets",
              "name": "[concat( parameters( 'vnet' ).name, '/', parameters( 'vnet' ).subnets.clientSubnet.name )]",
              "apiVersion": "[variables( 'apiVersion' ).Network ]",
              "properties": {
                "addressPrefix": "[parameters( 'vnet' ).subnets.clientSubnet.addressPrefix ]",
                "routeTable": {
                  "id": "[resourceId( 'Microsoft.Network/routeTables', concat( parameters( 'vnet' ).name, '-', parameters( 'vnet' ).subnets.clientSubnet.name, '-via-cuda' ))]"
                }
              }
            }
          ]
        }
      }
    },

    {
      "name": "firewall",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "[variables( 'apiVersion' ).Resources ]",
      "condition": true,
      "dependsOn": [
        "[resourceId( 'Microsoft.Resources/deployments', 'firewallNic' )]"
      ],
      "properties": {
        "templateLink": {
          "uri": "[concat( parameters( 'baseUrl'), '/fw.json' )]"
        },
        "mode": "[deployment().properties.mode]",
        "parameters": {
          "apiVersion": {
            "value": "[variables( 'apiVersion' )]"
          },
          "location": {
            "value": "[parameters( 'location' )]"
          },
          "fwVmName": {
            "value": "[parameters( 'fwVmName' )]"
          },
          "fwVmVersion": {
            "value": "[parameters( 'fwVmVersion' )]"
          },
          "fwVmSku": {
            "value": "[parameters( 'fwVmSku' )]"
          },
          "fwVmSize": {
            "value": "[parameters( 'fwVmSize' )]"
          },
          "fwPassword": {
            "value": "[parameters( 'fwPassword' )]"
          },
          "fwBootDiagnosticsStorage": {
            "value": ""
          },
          "fwBootDiagnosticsEnabled": {
            "value": false
          },
          "fwSshEnable": {
            "value": "[equals( parameters( 'fwSshEnable' ), '1' )]"
          },
          "fwSshKey": {
            "value": "[parameters( 'fwSshKey' )]"
          },
          "fwMgmtType": {
            "value": "[parameters( 'fwMgmtType' )]"
          },
          "fwCcData": {
            "value": "[parameters( 'fwCcData' )]"
          },
          "fwNicRef": {
            "value": "[reference( 'firewallNic', variables( 'apiVersion' ).Resources ).outputs.selfLink.value]"
          }
        }
      }
    }
  ],
  "outputs": {}
}
