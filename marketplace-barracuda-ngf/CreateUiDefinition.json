{
   "$schema": "https://schema.management.azure.com/schemas/0.1.2-preview/CreateUIDefinition.MultiVm.json",
   "handler": "Microsoft.Compute.MultiVm",
   "version": "0.1.2-preview",
   "parameters": {
      "basics": [
        {
          "name": "fwVmName",
          "type": "Microsoft.Common.TextBox",
          "label": "Firewall Instance Host Name",
          "toolTip": "Provide host name for newly created instance of Barracuda CloudGen Firewall",
          "defaultValue": "BarracudaNGFW",
          "constraints": {
            "required": true,
            "regex": "^[A-Za-z0-9-_]{1,15}$",
            "validationMessage": "Only alphanumeric characters are allowed, and the value must be 1 to 15 characters."
          }
        },
        {
          "name": "fwVmSku",
          "type": "Microsoft.Common.OptionsGroup",
          "label": "License scheme",
          "toolTip": "Choose between hourly billing via Azure Marketplace (PAYG) and Bring-Your-Own-License.",
          "defaultValue": "PAYG",
          "constraints": {
            "required": true,
            "allowedValues": [
              {
                "label": "PAYG",
                "value": "hourly"
              },
              {
                "label": "BYOL",
                "value": "byol"
              }
            ]
          }
        },
        {
          "name": "fwVmVersion",
          "type": "Microsoft.Common.DropDown",
          "label": "Firmware release version",
          "toolTip": "",
          "defaultValue": "7.2.0 (EA1)",
          "constraints": {
            "required": true,
            "allowedValues": [
              {
                "label": "7.2.0 (EA1)",
                "value": "7.2.015802"
              },
              {
                "label": "7.1.1 (LTS)",
                "value": "7.1.105602"
              },
              {
                "label": "7.0.4",
                "value": "7.0.308701"
              },
              {
                "label": "6.2.3",
                "value": "6.2.310801"
              }
            ]
          }
        }
       ],
      "steps": [
        {
          "name": "storage",
          "label": "Size and Storage",
          "subLabel": {
            "preValidation": "Define where to deploy your firewall",
            "postValidation": "Done"
          },
          "bladeTitle": "Size and Storage",
          "elements": [
            {
              "name": "fwVmSizeBasic",
              "type": "Microsoft.Common.DropDown",
              "label": "Firewall Instance Size",
              "toolTip": "Choose instance size corresponding to your license. ",
              "defaultValue": "Small (Level 2)",
              "constraints": {
                "required": true,
                "allowedValues": [
                  {
                    "label": "Small (Level 2)",
                    "value": "Standard_F1s"
                  },
                  {
                    "label": "Medium (Level 4)",
                    "value": "Standard_DS2_v2"
                  },
                  {
                    "label": "Large (Level 6)",
                    "value": "Standard_DS3_v2"
                  },
                  {
                    "label": "X-Large (Level 8)",
                    "value": "Standard_DS4_v2"
                  }
                ]
              },
              "visible": true
            },
            {
              "name": "storageIsManaged",
              "type": "Microsoft.Common.OptionsGroup",
              "label": "Use managed disks",
              "toolTip": "Enable this feature to have Azure automatically manage the availability of disks to provide data redundancy and fault tolerance, without creating and managing storage accounts on your own. Managed disks may not be available in all regions.",
              "defaultValue": "Yes",
              "constraints": {
                "required": true,
                "allowedValues": [
                  {
                    "label": "Yes",
                    "value": "1"
                  },
                  {
                    "label": "No",
                    "value": "0"
                  }
                ]
              }
            },
            {
              "name": "storageAccount",
              "type": "Microsoft.Storage.StorageAccountSelector",
              "label": "Storage Account",
              "toolTip": "Storage Account for the disk image of the Barracuda NextGen Firewall",
              "defaultValue": {
                "type": "Standard_LRS"
              },
              "constraints": {
                "allowedTypes": [
                  "Standard_LRS",
                  "Premium_LRS"
                ],
                "required": true
              },
              "options": {
                "hideExisting": false
              },
              "visible": "[equals( steps('storage').storageIsManaged, '0' )]"
            }


          ]
        },
        {
          "name": "networking",
          "label": "Networking",
          "subLabel": {
            "preValidation": "",
            "postValidation": "Done"
          },
          "bladeTitle": "Network",
          "elements": [
            {
              "name": "virtualNetwork",
              "type": "Microsoft.Network.VirtualNetworkCombo",
              "label": {
                "virtualNetwork": "Virtual network",
                "subnets": "Subnets"
              },
              "toolTip": {
                "virtualNetwork": "Virtual Network Name",
                "subnets": "Create a separate subnet for Barracuda NGFW"
              },
              "defaultValue": {
                "name": "newVirtualNetwork",
                "addressPrefixSize": "/16"
              },
              "constraints": {
                "minAddressPrefixSize": "/24"
              },
              "options": {
                "hideExisting": false
              },
              "subnets": {
                "fwSubnet": {
                  "label": "Firewall Subnet",
                  "defaultValue": {
                    "name": "FirewallSubnet",
                    "addressPrefixSize": "/29"
                  },
                  "constraints": {
                    "minAddressPrefixSize": "/30",
                    "minAddressCount": 2,
                    "requireContiguousAddresses": false
                  }
                }
              }
            },
            {
              "name": "publicIp",
              "type": "Microsoft.Network.PublicIpAddressCombo",
              "label": {
                "publicIpAddress": "Public IP Address Name",
                "domainNameLabel": "Domain Name Label"
              },
              "toolTip": {
                "publicIpAddress": "Name of public IP address ARM resource",
                "domainNameLabel": "Prefix to use for public IP address DNS name (e.g. [prefix].region.cloudapp.azure.com)"
              },
              "defaultValue": {
                "publicIpAddress": "[concat( basics( 'fwVmName' ), '-pip' )]",
                "domainNameLabel": "[basics( 'fwVmName' )]"
              },
              "options": {
                "hideNone": false,
                "hideDomainNameLabel": false,
                "hideExisting": false
              },
              "constraints": {
                "required": false
              },
              "visible": true
            }

          ]
        },
        {
          "name": "ngfManagement",
          "label": "Firewall Management",
          "subLabel": {
            "preValidation": "",
            "postValidation": "Done"
          },
          "bladeTitle": "Firewall Management",
          "elements": [

          ]
        },
        {
          "name": "advanced",
          "label": "",
          "subLabel": {
            "preValidation": "",
            "postValidation": "Done"
          },
          "bladeTitle": "",
          "elements": [
            {
              "name": "fwVmAddress",
              "type": "Microsoft.Common.TextBox",
              "label": "Barracuda NextGen Firewall Private IP Address",
              "toolTip": "Provide IP address from Firewall Subnet defined above",
              "defaultValue": "[steps( 'networking' ).virtualNetwork.subnets.fwSubnet.startAddress]",
              "constraints": {
                "required": false,
                "regex": "^([01]?\\d\\d?|2[0-4]\\d|25[0-5])\\.([01]?\\d\\d?|2[0-4]\\d|25[0-5])\\.([01]?\\d\\d?|2[0-4]\\d|25[0-5])\\.([01]?\\d\\d?|2[0-4]\\d|25[0-5])$",
                "validationMessage": "Must be a valid IPv4 address from Firewall Subnet"
              }
            },
            {
              "name": "fwVmSize",
              "type": "Microsoft.Compute.SizeSelector",
              "label": "Virtual firewall instance size",
              "toolTip": "The size of virtual machine to provision.",
              "recommendedSizes": [
                "[steps( 'storage' ).fwVmSizeBasic]",
                "Standard_F1s",
                "Standard_D2s_v2",
                "Standard_D3s_v2",
                "Standard_D4s_v2"
              ],
              "constraints": {
                "allowedSizes": [
                  "Standard_F1s",
                  "Standard_F2s",
                  "Standard_F4s",
                  "Standard_F8s",
                  "Standard_F1s_v2",
                  "Standard_F2s_v2",
                  "Standard_F4s_v2",
                  "Standard_F8s_v2"
                  "Standard_DS2_v2",
                  "Standard_DS3_v2",
                  "Standard_DS4_v2",
                  "Standard_DS2_v3",
                  "Standard_DS3_v3",
                  "Standard_DS4_v3"
                ],
                "required": true
              },
              "osPlatform": "Linux",
              "imageReference": {
                "publisher": "barracudanetworks",
                "offer": "barracuda-ng-firewall",
                "sku": "[basics( 'fwVmSku' )]"
              },
              "count": "1"
            }
          ]
        }
      ],
      "outputs": {
        "fwVmName": "[basics( 'fwVmName' )]",
        "fwVmVersion": "[basics( 'fwVmVersion' )]",
        "fwVmSku": "[basics( 'fwVmSku' )]"
      }
   }
}
