{
   "$schema": "https://schema.management.azure.com/schemas/0.1.2-preview/CreateUIDefinition.MultiVm.json",
   "handler": "Microsoft.Compute.MultiVm",
   "version": "0.1.2-preview",
   "parameters": {
      "basics": [
        {
          "name": "fwVmName",
          "type": "Microsoft.Common.TextBox",
          "label": "Firewall Instance Host Name",
          "toolTip": "Provide host name for newly created instance of Barracuda CloudGen Firewall",
          "defaultValue": "BarracudaNGFW",
          "constraints": {
            "required": true,
            "regex": "^[A-Za-z0-9-_]{1,15}$",
            "validationMessage": "Only alphanumeric characters are allowed, and the value must be 1 to 15 characters."
          }
        },
        {
          "name": "fwVmSku",
          "type": "Microsoft.Common.OptionsGroup",
          "label": "License scheme",
          "toolTip": "Choose between hourly billing via Azure Marketplace (PAYG) and Bring-Your-Own-License.",
          "defaultValue": "PAYG",
          "constraints": {
            "required": true,
            "allowedValues": [
              {
                "label": "PAYG",
                "value": "hourly"
              },
              {
                "label": "BYOL",
                "value": "byol"
              }
            ]
          }
        },
        {
          "name": "fwVmVersion",
          "type": "Microsoft.Common.DropDown",
          "label": "Firmware release version",
          "toolTip": "Select your preferred firmware version. 'EA' stands for Early Availability - this release is not recommended for critical deployments, 'LTS' stands for Long Term Support. Check [Barracuda EoS plan](https://campus.barracuda.com/doc/71860849/) and [Release Notes](https://campus.barracuda.com/doc/73723948/) for more details.",
          "defaultValue": "7.2.0 (EA1)",
          "constraints": {
            "required": true,
            "allowedValues": [
              {
                "label": "7.2.0 (EA1)",
                "value": "7.2.015802"
              },
              {
                "label": "7.1.1 (LTS)",
                "value": "7.1.105602"
              },
              {
                "label": "7.0.4",
                "value": "7.0.308701"
              },
              {
                "label": "6.2.3",
                "value": "6.2.310801"
              }
            ]
          }
        }
       ],
      "steps": [
        {
          "name": "storage",
          "label": "Size and Storage",
          "subLabel": {
            "preValidation": "Size your firewall",
            "postValidation": "Done"
          },
          "bladeTitle": "Size and Storage",
          "elements": [
            {
              "name": "fwVmCores",
              "type": "Microsoft.Common.DropDown",
              "label": "Firewall Instance Size",
              "toolTip": "Choose instance size corresponding to your license. Recommended instance type will be automatically selected, but you can override this recommendation in Advanced Settings step.",
              "defaultValue": "Small (Level 2)",
              "constraints": {
                "required": true,
                "allowedValues": [
                  {
                    "label": "Small - Level 2 (1 core)",
                    "value": "1"
                  },
                  {
                    "label": "Medium - Level 4 (2 cores)",
                    "value": "2"
                  },
                  {
                    "label": "Large - Level 6 (4 cores)",
                    "value": "4"
                  },
                  {
                    "label": "X-Large - Level 8 (8 cores)",
                    "value": "8"
                  }
                ]
              },
              "visible": true
            },
            {
              "name": "storageIsManaged",
              "type": "Microsoft.Common.OptionsGroup",
              "label": "Use managed disks",
              "toolTip": "Enable this feature to have Azure automatically manage the availability of disks to provide data redundancy and fault tolerance, without creating and managing storage accounts on your own. Managed disks may not be available in all regions.",
              "defaultValue": "Yes",
              "constraints": {
                "required": true,
                "allowedValues": [
                  {
                    "label": "Yes",
                    "value": "1"
                  },
                  {
                    "label": "No",
                    "value": "0"
                  }
                ]
              }
            },
            {
              "name": "storageAccount",
              "type": "Microsoft.Storage.StorageAccountSelector",
              "label": "Storage Account",
              "toolTip": "Storage Account for the disk image of the Barracuda NextGen Firewall",
              "defaultValue": {
                "type": "Premium_LRS"
              },
              "constraints": {
                "allowedTypes": [
                  "Premium_LRS"
                ],
                "required": true
              },
              "options": {
                "hideExisting": false
              },
              "visible": "[equals( steps('storage').storageIsManaged, '0' )]"
            }


          ]
        },
        {
          "name": "network",
          "label": "Networking",
          "subLabel": {
            "preValidation": "",
            "postValidation": "Done"
          },
          "bladeTitle": "Network",
          "elements": [
            {
              "name": "netPrivate",
              "type": "Microsoft.Common.Section",
              "label": "Private networking configuration",
              "elements": [
                {
                  "name": "virtualNetwork",
                  "type": "Microsoft.Network.VirtualNetworkCombo",
                  "label": {
                "virtualNetwork": "Virtual network",
                "subnets": "Subnets"
              },
                  "toolTip": {
                "virtualNetwork": "Select existing or create a new VNet for your firewall deployment",
                "subnets": "If you plan to protect outgoing or internal traffic with this firewall, it must be placed in a subnet separated from protected instances. [Read more about user-defined routes](https://docs.microsoft.com/en-us/azure/virtual-network/virtual-networks-udr-overview#user-defined)"
              },
                  "defaultValue": {
                "name": "newVirtualNetwork",
                "addressPrefixSize": "/16"
              },
                  "constraints": {
                "minAddressPrefixSize": "/24"
              },
                  "options": {
                "hideExisting": false
              },
                  "subnets": {
                "fwSubnet": {
                  "label": "Firewall Subnet",
                  "defaultValue": {
                    "name": "FirewallSubnet",
                    "addressPrefixSize": "/29"
                  },
                  "constraints": {
                    "minAddressPrefixSize": "/30",
                    "minAddressCount": 2,
                    "requireContiguousAddresses": false
                  }
                }
              }
                }
              ]
            },
            {
              "name": "netPublic",
              "type": "Microsoft.Common.Section",
              "label": "Public networking configuration",
              "elements": [
                {
                  "name": "publicIp",
                  "type": "Microsoft.Network.PublicIpAddressCombo",
                  "label": {
                "publicIpAddress": "Public IP Address Name",
                "domainNameLabel": "Domain Name Label"
              },
                  "toolTip": {
                "publicIpAddress": "Name of public IP address ARM resource",
                "domainNameLabel": "Prefix to use for public IP address DNS name (e.g. [prefix].region.cloudapp.azure.com)"
              },
                  "defaultValue": {
                "publicIpAddress": "[concat( basics( 'fwVmName' ), '-pip' )]",
                "domainNameLabel": ""
              },
                  "options": {
                "hideNone": false,
                "hideDomainNameLabel": false,
                "hideExisting": false
              },
                  "constraints": {
                "required": false
              },
                  "visible": true
                }
              ]
            }

          ]
        },
        {
          "name": "ngfManagement",
          "label": "Firewall Management",
          "subLabel": {
            "preValidation": "",
            "postValidation": "Done"
          },
          "bladeTitle": "Firewall Management",
          "elements": [
            {
              "name": "fwParFile",
              "type": "Microsoft.Common.FileUpload",
              "label": "Restore from PAR file. This will restore configuration from provided PAR (Barracuda CloudGen Firewall configuration backup) file. Make sure your IP configuration for this instance matches the one in PAR file.",
              "toolTip": "",
              "constraints": {
                "required": false,
                "accept": ".par,.pgz"
              },
              "options": {
                "multiple": false,
                "uploadMode": "url",
                "openMode": "binary",
                "encoding": "UTF-8"
              },
              "visible": true
            },
            {
              "name": "fwAcl",
              "type": "Microsoft.Common.TextBox",
              "label": "Management ACL",
              "defaultValue": "0.0.0.0/0",
              "toolTip": "Restrict management connections to the firewall to this subnet. If not 0.0.0.0/0, this setting will introduce a Network Security Group restricting access to management ports of the firewall.",
              "constraints": {
                "required": true,
                "regex": "^([01]?\\d\\d?|2[0-4]\\d|25[0-5])\\.([01]?\\d\\d?|2[0-4]\\d|25[0-5])\\.([01]?\\d\\d?|2[0-4]\\d|25[0-5])\\.([01]?\\d\\d?|2[0-4]\\d|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$",
                "validationMessage": "Please provide subnet address in CIDR notation"
              },
              "visible": true
            },
            {
              "name": "fwMgmtType",
              "type": "Microsoft.Common.DropDown",
              "label": "Firewall management tool",
              "defaultValue": "Firewall Admin app",
              "toolTip": "Choose the way to manage your firewall",
              "constraints": {
                "allowedValues": [
                  {
                    "label": "Web UI",
                    "value": "webui"
                  },
                  {
                    "label": "Firewall Admin app",
                    "value": "ngadmin"
                  },
                  {
                    "label": "Centrally managed via Control Center",
                    "value": "ngcc"
                  }
                ]
              },
            "visible": "[empty( steps( 'ngfManagement' ).fwParFile )]"
          },
          {
            "name": "fwPassword",
            "type": "Microsoft.Common.PasswordBox",
            "label": {
              "password": "Root Password",
              "confirmPassword": "Confirm password"
            },
            "toolTip": "",
            "constraints": {
              "required": "[and(empty( steps( 'ngfManagement' ).fwParFile), not( equals( steps( 'ngfManagement' ).fwMgmtType, 'ngcc' )))]",
              "regex": "",
              "validationMessage": ""
            },
            "options": {
              "hideConfirmation": false
            },
            "visible": "[and(empty( steps( 'ngfManagement' ).fwParFile), not( equals( steps( 'ngfManagement' ).fwMgmtType, 'ngcc' )))]"
          },
          {
            "name": "ngcc",
            "type": "Microsoft.Common.Section",
            "label": "Control Center binding",
            "elements": [
              {
                "name": "ccIpAddress",
                "type": "Microsoft.Common.TextBox",
                "label": "IP Address of Control Center",
                "toolTip": "Publicly reachable IP address of Control Center",
                "constraints": {
                  "required": true,
                  "regex": "^([01]?\\d\\d?|2[0-4]\\d|25[0-5])\\.([01]?\\d\\d?|2[0-4]\\d|25[0-5])\\.([01]?\\d\\d?|2[0-4]\\d|25[0-5])\\.([01]?\\d\\d?|2[0-4]\\d|25[0-5])$",
                  "validationMessage": "Must be a valid IPv4 address of NGCC"
                }
              },
              {
                "name": "ccRangeId",
                "type": "Microsoft.Common.TextBox",
                "label": "Range ID for firewall box",
                "toolTip": "ID number of NGCC range hosting deployed NGFW instance configuration",
                "constraints": {
                  "required": true,
                  "regex": "^[0-9]{1,2}$",
                  "validationMessage": "Must be a range ID number"
                }
              },
              {
                "name": "ccClusterName",
                "type": "Microsoft.Common.TextBox",
                "label": "Cluster name for firewall box",
                "toolTip": "Name of cluster hosting deployed NGFW instance configuration",
                "constraints": {
                  "required": true,
                  "regex": "^[a-zA-Z0-9-]{1,16}$",
                  "validationMessage": "Must be a valid NGCC cluster name"
                }
              },
              {
                "name": "ccSecret",
                "type": "Microsoft.Common.TextBox",
                "label": "PAR file retrieval key",
                "toolTip": "PAR file retrieval shared key from Box Properties > Operational settings",
                "constraints": {
                  "required": true
                },
                "options": {
                  "hideConfirmation": true
                }
              }
            ],
            "visible": "[equals( 'ngcc', steps( 'ngfManagement' ).fwMgmtType )]"
          }

        ]
        },
        {
          "name": "advanced",
          "label": "Advanced",
          "subLabel": {
            "preValidation": "",
            "postValidation": "Done"
          },
          "bladeTitle": "Advanced Settings",
          "elements": [
            {
              "name": "fwVmAddress",
              "type": "Microsoft.Common.TextBox",
              "label": "Barracuda CloudGen Firewall private IP address",
              "toolTip": "Provide static IP address from Firewall Subnet defined above",
              "defaultValue": "[steps( 'network' ).netPrivate.virtualNetwork.subnets.fwSubnet.startAddress]",
              "constraints": {
                "required": false,
                "regex": "^([01]?\\d\\d?|2[0-4]\\d|25[0-5])\\.([01]?\\d\\d?|2[0-4]\\d|25[0-5])\\.([01]?\\d\\d?|2[0-4]\\d|25[0-5])\\.([01]?\\d\\d?|2[0-4]\\d|25[0-5])$",
                "validationMessage": "Must be a valid IPv4 address from Firewall Subnet"
              }
            },
            {
              "name": "fwVmSize",
              "type": "Microsoft.Compute.SizeSelector",
              "label": "Virtual firewall instance size",
              "toolTip": "The size of virtual machine to provision.",
              "recommendedSizes": [
                "[concat( 'Standard_F', steps( 'storage' ).fwVmCores, 's' )]",
                "[concat( 'Standard_DS', string( div( int( steps( 'storage' ).fwVmCores), 2 )), '_v2' )]",
                "[concat( 'Standard_F', steps( 'storage' ).fwVmCores, 's_v2' )]",
                "[concat( 'Standard_DS', steps( 'storage' ).fwVmCores, '_v3' )]"
              ],
              "constraints": {
                "allowedSizes": [
                  "Standard_F1s",
                  "Standard_F2s",
                  "Standard_F4s",
                  "Standard_F8s",
                  "Standard_F1s_v2",
                  "Standard_F2s_v2",
                  "Standard_F4s_v2",
                  "Standard_F8s_v2",
                  "Standard_DS2_v2_Promo",
                  "Standard_DS3_v2_Promo",
                  "Standard_DS4_v2_Promo",
                  "Standard_DS2_v2",
                  "Standard_DS3_v2",
                  "Standard_DS4_v2",
                  "Standard_DS2_v3",
                  "Standard_DS4_v3",
                  "Standard_DS8_v3",
                  "Standard_B1ms",
                  "Standard_B2s",
                  "Standard_B2ms",
                  "Standard_B4ms",
                  "Standard_B8ms"
                ],
                "options": {
                  "hideDiskTypeFilter": true
                },
                "required": true
              },
              "osPlatform": "Linux",
              "imageReference": {
                "publisher": "barracudanetworks",
                "offer": "barracuda-ng-firewall",
                "sku": "[basics( 'fwVmSku' )]"
              },
              "count": "1"
            },
            {
              "name": "fwSshEnable",
              "type": "Microsoft.Common.OptionsGroup",
              "label": "SSH Management Access",
              "defaultValue": "Disabled",
              "toolTip": "Enabling SSH access will configure firewall SSH settings to allow root login via SSH with key-based authentication. SSH connections are subject for Management ACL settings",
              "constraints": {
                "allowedValues": [
                  {
                    "label": "Disabled",
                    "value": "0"
                  },
                  {
                    "label": "Enabled",
                    "value": "1"
                  }
                ]
              },
              "visible": true
            },
            {
              "name": "fwSshKey",
              "type": "Microsoft.Compute.CredentialsCombo",
              "label": {
                "authenticationType": "Authentication type",
                "password": "Password",
                "confirmPassword": "Confirm password",
                "sshPublicKey": "SSH public key"
              },
              "toolTip": {
                "authenticationType": "",
                "password": "",
                "sshPublicKey": ""
              },
              "constraints": {
                "required": "[equals( steps('advanced').fwSshEnable, '1' )]",
                "customPasswordRegex": "^(?=.*[A-Za-z])(?=.*\\d)[A-Za-z\\d]{8,}$",
                "customValidationMessage": "The password must contain at least 8 characters, with at least 1 letter and 1 number."
              },
              "options": {
                "hideConfirmation": true,
                "hidePassword": true
              },
              "osPlatform": "Linux",
              "visible": "[equals( steps('advanced').fwSshEnable, '1' )]"
            }
          ]
        }
      ],
      "outputs": {
        "fwVmName": "[basics( 'fwVmName' )]",
        "fwVmVersion": "[basics( 'fwVmVersion' )]",
        "fwVmSku": "[basics( 'fwVmSku' )]",
        "fwVmSize": "[steps( 'advanced' ).fwVmSize ]",
        "fwVmAddress": "[steps( 'advanced' ).fwVmAddress ]",
        "fwSubnetName": "[steps( 'network' ).virtualNetwork.netPrivate.subnets.fwSubnet.name ]",
        "fwSubnetAddress": "[steps( 'network' ).virtualNetwork.netPrivate.subnets.fwSubnet.addressPrefix ]",
        "publicIpName": "[steps( 'network' ).netPublic.publicIp.name ]",
        "publicIpDnsName": "[steps( 'network' ).netPublic.publicIp.domainNameLabel ]",
        "publicIpAddressType": "Dynamic",
        "publicIpNewOrNone": "[steps( 'network' ).netPublic.publicIp.newOrExistingOrNone ]",
        "publicIp": "[steps( 'network' ).netPublic.publicIp ]",
        "publicIpRG": "[steps( 'network' ).netPublic.publicIp.resourceGroup ]",
        "newStorageAccountName": "[steps( 'storage' ).storageAccount.name ]",
        "newStorageAccountType": "[steps( 'storage' ).storageAccount.type ]",
        "vnetName": "[steps( 'network' ).netPrivate.virtualNetwork.name ]",
        "vnetAddressSpace": "[steps( 'network').netPrivate.virtualNetwork.addressPrefix ]",
        "vnetRG": "[steps( 'network' ).netPrivate.virtualNetwork.resourceGroup ]",
        "ccIpAddress": "[steps( 'ngfManagement' ).ngcc.ccIpAddress ]",
        "ccClusterName": "[steps( 'ngfManagement' ).ngcc.ccClusterName ]",
        "ccRangeId": "[steps( 'ngfManagement' ).ngcc.ccRangeId ]",
        "ccSecret": "[steps( 'ngfManagement' ).ngcc.ccSecret ]",
        "fwParFileUrl": "[steps( 'ngfManagement' ).fwParFile ]",
        "fwSShEnable": "[steps( 'advanced' ).fwSshEnable ]",
        "fwSshKey": "[steps( 'advanced' ).fwSshKey ]"
      }
   }
}
